<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <!-- 写模板 -->
    <div id="root">
      <p>{{name.firstName}}</p>
    </div>

    <script>
      //要解决的问题: 使用'xxxx.yyy.zzz'可以访问到某个对象的值
      //需要用字符串路径来访问对象的成员
      function getValueByPath(obj, path) {
        let paths = path.split("."); //[xxx,yyy,zzz]

        let res = obj;
        let prop;
        while ((prop = paths.shift())) {
          res = res[prop];
        }
        return res;
      }

      let rkuohao = /\{\{(.+?)\}\}/g;
      function compiler(template, data) {
        let childNodes = template.childNodes;
        for (let i = 0; i < childNodes.length; i++) {
          let type = childNodes[i].nodeType; //1 元素，3 文本节点
          if (type === 3) {
            //文本节点可以判断里面是否有双括弧的差值
            let txt = childNodes[i].nodeValue; //该元素只有文本节点才有意义

            //判断有没有花括号
            txt = txt.replace(rkuohao, function (_, g) {
              //使用正则匹配一次函数就会调用一次，函数的第0个参数表示匹配到的内容，函数中的第n个参数表示正则中的第n组（一个括号表示一组）

              let path = g.trim(); //只取写在花括号里面的东西
              let value = getValueByPath(data, path);

              //将{{xxxx}}用这个值替换

              return value;
            });

            //注意 现在txt 和 DOM元素是没有关系的
            childNodes[i].nodeValue = txt;
          } else if (type === 1) {
            //元素需要考虑他有没有子元素，是否需要对其子元素进行判断是否具有插值
            compiler(childNodes[i], data);
          }
        }
      }

      function JGVue(options) {
        //习惯：内部数据使用下划线  _ 开头，只读数据使用 $ 开头
        this._data = options.data;
        this._el = options.el;

        //准备工作

        this._templateDOM = document.querySelector(this._el);

        this._parent = this._templateDOM.parentNode;

        //渲染工作
        this.render();
      }

      //将模板 和 数据 得到的HTML加载到页面
      JGVue.prototype.render = function () {
        this.compiler();
      };

      //将模板与数结合 得到真正的 DOM 元素
      JGVue.prototype.compiler = function () {
        let realHTMLDOM = this._templateDOM.cloneNode(true);
        compiler(realHTMLDOM, this._data);
        this.update(realHTMLDOM);
      };

      //将DOM 元素放到页面中
      JGVue.prototype.update = function (real) {
        this._parent.replaceChild(real, document.querySelector("#root"));
      };

      let app = new JGVue({
        el: "#root",
        data: {
          name: {
            firstName: "张",
            lastName: "三峰",
          },
        },
      });

      //还有一些要处理的问题：
      //1.怎么将虚拟DOM转换为真正的DON
      //2.怎么将虚拟DOM转换为真正的DOM
    </script>
  </body>
</html>
